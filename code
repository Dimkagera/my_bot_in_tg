from aiogram import F
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
import json
import os
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
import asyncio
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import Message
import logging
token = '7980507312:AAEKF04H83yriQ1mVp7z1YkEn_WZ3zGkkCo'
chat_id = None
interval = 60
bot = Bot(token=token)
dp = Dispatcher()

scheduler_running = False
async def send_periodic_messages():
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    global scheduler_running
    scheduler_running = True

    while scheduler_running:
        try:
            await bot.send_message(
                chat_id=chat_id,
                text='–∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫')
            # –û–∂–∏–¥–∞–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            await asyncio.sleep(interval)

        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–¥–æ–∂–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º
            await asyncio.sleep(10)


@dp.message(Command('start'))
async def staring(message: types.Message):
    global chat_id, scheduler_running

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —á–∞—Ç–∞, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∞ –∫–æ–º–∞–Ω–¥–∞
    chat_id = message.chat.id
    user = message.from_user
    await message.answer(f"üëã–ü—Ä–∏–≤–µ—Ç, {user.first_name}, –∑–¥–µ—Å—å —Ç—ã —Å–º–æ–∂–µ—à—å —É–∑–Ω–∞—Ç—å —Å–≤–æ–∏ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã.")


@dp.message(Command("start_scheduler"))
async def cmd_start_scheduler(message: Message):
    global scheduler_running, chat_id

    if not chat_id:
        chat_id = message.chat.id

    if not scheduler_running:
        asyncio.create_task(send_periodic_messages())
        await message.answer(f"‚úÖ –ü–æ–¥—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –∑–∞–ø—É—â–µ–Ω")
    else:
        await message.answer("‚ö†Ô∏è –ü–æ–¥—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω")


@dp.message(Command("stop_scheduler"))
async def cmd_stop_scheduler(message: Message):
    """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞"""
    global scheduler_running

    if scheduler_running:
        scheduler_running = False
        await message.answer("üõë –ü–æ–¥—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    else:
        await message.answer("‚ö†Ô∏è –ü–æ–¥—Å—á—ë—Ç –∑–∞—Ç—Ä–∞—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω")


@dp.message(Command('url'))
async def show_buttons(message: types.Message):
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏:
    button1 = InlineKeyboardButton(
        text="–°—Å—ã–ª–∫–∞ –Ω–∞ –¢–ì–ö",  # –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
        url = "t.me/firawants"  # –î–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–¥—É—Ç –≤ callback
    )

    button2 = InlineKeyboardButton(
        text="–°—Å—ã–ª–∫–∞ –Ω–∞ GitHub",  # –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
        url="https://github.com/Dimkagera"  # URL –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ (–Ω–µ callback!)
    )

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–ø–∏—Å–æ–∫ —Å–ø–∏—Å–∫–æ–≤ - —Å—Ç—Ä–æ–∫–∏ –∫–Ω–æ–ø–æ–∫)
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [button1],  # –ü–µ—Ä–≤—ã–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫
            [button2]  # –í—Ç–æ—Ä–æ–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫
        ]
    )

    await message.answer("–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=keyboard)





async def main():

    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
